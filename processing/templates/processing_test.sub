# ==============================================================================
# processing_test.sub - HTCondor submit file for MC processing (TEST MODE)
# ==============================================================================
# This template runs the full chain with reduced events for testing.
# Uses --max-events flag to limit processing to ~100 events.
# ==============================================================================

Universe = vanilla

# Executable and arguments - limit to 100 events
Executable = /afs/cern.ch/user/x/xcheng/condor/MC_Production_DAG/T2_CN_Beijing/processing/run_chain.sh
Arguments = --inputs $(inputs) --modes $(modes) --analysis $(analysis) --campaign $(campaign) --job-id $(job_id) --max-events 100

# Input files to transfer (self-contained sandbox)
Transfer_Input_Files = /afs/cern.ch/user/x/xcheng/condor/MC_Production_DAG/T2_CN_Beijing/processing/run_chain.sh, \
                       /afs/cern.ch/user/x/xcheng/condor/MC_Production_DAG/T2_CN_Beijing/processing/pythia_shower, \
                       /afs/cern.ch/user/x/xcheng/condor/MC_Production_DAG/T2_CN_Beijing/common

# Output handling (match production: stage-out via XRootD, no AFS transfer)
transfer_output_files =

# Log files
Output = log/proc_test_$(campaign)_$(job_id)_$(Cluster)_$(Process).stdout
Error = log/proc_test_$(campaign)_$(job_id)_$(Cluster)_$(Process).stderr
Log = log/proc_test_$(campaign)_$(job_id)_$(Cluster)_$(Process).log

# Resource requirements (reduced for test)
request_cpus = 4
request_memory = 16GB
request_disk = 30GB

# Target T2_CN_Beijing site
+DESIRED_Sites = "T2_CN_Beijing"

+MaxRuntime = 86400

# X509 proxy for XRootD storage access
x509userproxy = /afs/cern.ch/user/x/xcheng/x509up_u180107
use_x509userproxy = true

# Run in CMSSW-compatible container (el9 for CMSSW_14 compatibility)
+SingularityImage = "/cvmfs/unpacked.cern.ch/registry.hub.docker.com/cmssw/el8:x86_64"

# Environment setup - align with production (HOME on /srv)
Environment = "HOME=/srv X509_USER_PROXY=/afs/cern.ch/user/x/xcheng/x509up_u180107"

# Retry configuration
MaxRetries = 1
OnExitHold = (ExitCode != 0)
OnExitHoldReason = "Job exited with non-zero status"

# No host OS requirement - we run inside Singularity container
# Requirements removed - el8 container runs fine on AlmaLinux9 hosts

Queue 1
